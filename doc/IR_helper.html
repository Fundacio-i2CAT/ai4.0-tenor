<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: IR_helper
  
    &mdash; Documentation by YARD 0.9.5
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "IR_helper";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index (I)</a> &raquo;
    
    
    <span class="title">IR_helper</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <iframe id="search_frame" src="class_list.html"></iframe>

      <div id="content"><h1>Class: IR_helper
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">IR_helper</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>service-mapper/helpers/sm-unimi_IR_helper.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>require_relative &#39;sm-unimi_dummyRest&#39;</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#clear_unused_keys-instance_method" title="#clear_unused_keys (instance method)">#<strong>clear_unused_keys</strong>(input_hash)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Aux function for removing all the useless key/value pairs from each
response.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#queryIR-instance_method" title="#queryIR (instance method)">#<strong>queryIR</strong>(ir_address, simulation, debugprint, overcommiting)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Queries the IR database for all the datas needed by the mapping algo; these
are both aggregate resources and DC features resources.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="clear_unused_keys-instance_method">
  
    #<strong>clear_unused_keys</strong>(input_hash)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Aux function for removing all the useless key/value pairs from each
response</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


335
336
337
338
339
340
341
342
343
344
345</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'service-mapper/helpers/sm-unimi_IR_helper.rb', line 335</span>

<span class='kw'>def</span> <span class='id identifier rubyid_clear_unused_keys'>clear_unused_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_input_hash'>input_hash</span><span class='rparen'>)</span>
	<span class='kw'>if</span> <span class='id identifier rubyid_input_hash'>input_hash</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>actions</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
		<span class='id identifier rubyid_input_hash'>input_hash</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>actions</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
	<span class='kw'>end</span>
	<span class='kw'>if</span> <span class='id identifier rubyid_input_hash'>input_hash</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>kind</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
		<span class='id identifier rubyid_input_hash'>input_hash</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>kind</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
	<span class='kw'>end</span>
	<span class='kw'>if</span> <span class='id identifier rubyid_input_hash'>input_hash</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mixins</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
		<span class='id identifier rubyid_input_hash'>input_hash</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>mixins</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
	<span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="queryIR-instance_method">
  
    #<strong>queryIR</strong>(ir_address, simulation, debugprint, overcommiting)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Queries the IR database for all the datas needed by the mapping algo; these
are both aggregate resources and DC features resources. Data is then saved
in bin/workspace/NI.json</p>

<p>See <a
href="http://wiki.t-nova.eu/tnovawiki/index.php/Final_Infrastructure_API_available">wiki.t-nova.eu/tnovawiki/index.php/Final_Infrastructure_API_available</a>
and <a
href="http://wiki.t-nova.eu/tnovawiki/index.php/T3.2_Infrastructure_Repository">wiki.t-nova.eu/tnovawiki/index.php/T3.2_Infrastructure_Repository</a>
for a complete API reference</p>

<p>API supports filtering, i.e.</p>

<pre class="code ruby"><code class="ruby">GET/&lt;PoP_ID&gt;/Resources?Type=VM&amp;State=running</code></pre>

<p>or</p>

<pre class="code ruby"><code class="ruby">GET/&lt;PoP_ID&gt;/Resources?Type=Service&amp;State=Enable</code></pre>

<p>but I haven&#39;t had the chance to try them in a working environment. Code
may change drastically if I decide to implement filtered-based queries!</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'service-mapper/helpers/sm-unimi_IR_helper.rb', line 47</span>

<span class='kw'>def</span> <span class='id identifier rubyid_queryIR'>queryIR</span><span class='lparen'>(</span><span class='id identifier rubyid_ir_address'>ir_address</span><span class='comma'>,</span> <span class='id identifier rubyid_simulation'>simulation</span><span class='comma'>,</span> <span class='id identifier rubyid_debugprint'>debugprint</span><span class='comma'>,</span> <span class='id identifier rubyid_overcommiting'>overcommiting</span><span class='rparen'>)</span>

	<span class='id identifier rubyid_conv'>conv</span> <span class='op'>=</span> <span class='const'>Sm_converters</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
	<span class='comment'>#dummyRest = Sm_dummyRest.new
</span>
	<span class='comment'># by assigning an invalid base address, an exception is generated by each RestClient.get and the
</span>	<span class='comment'># dummy stuff is invoked instead
</span>	<span class='kw'>if</span> <span class='id identifier rubyid_simulation'>simulation</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>true</span><span class='tstring_end'>&quot;</span></span>
		<span class='id identifier rubyid_base_ir_address'>base_ir_address</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_</span><span class='tstring_end'>&quot;</span></span>
	<span class='kw'>else</span>
		<span class='id identifier rubyid_base_ir_address'>base_ir_address</span> <span class='op'>=</span> <span class='id identifier rubyid_ir_address'>ir_address</span>
	<span class='kw'>end</span>

	<span class='comment'># request list of PoP
</span>	<span class='id identifier rubyid_pop_id_array'>pop_id_array</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
	<span class='id identifier rubyid_temp_h'>temp_h</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
	<span class='kw'>begin</span>
		<span class='id identifier rubyid_pop_list'>pop_list</span> <span class='op'>=</span> <span class='const'>RestClient</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_base_ir_address'>base_ir_address</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/pop/</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='symbol'>:accept</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/occi+json</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
	<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
		<span class='kw'>if</span> <span class='id identifier rubyid_debugprint'>debugprint</span> <span class='op'>==</span> <span class='kw'>true</span>
			<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>API call fail /pop/\n</span><span class='tstring_end'>&#39;</span></span>
			<span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_e'>e</span>
		<span class='kw'>end</span>
		<span class='kw'>return</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>status</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='op'>-</span><span class='int'>16</span><span class='comma'>,</span>
				<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API call fail: /pop</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
		<span class='comment'>##pop_list = dummyRest.dummy_pop_query()
</span>	<span class='kw'>end</span>
	<span class='id identifier rubyid_temp_h'>temp_h</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_pop_list'>pop_list</span><span class='rparen'>)</span>
	<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Numbers of PoPs = </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_temp_h'>temp_h</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
	<span class='id identifier rubyid_temp_h'>temp_h</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_pop'>pop</span><span class='op'>|</span>
		<span class='id identifier rubyid_pop_id_array'>pop_id_array</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_pop'>pop</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>identifier</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
	<span class='kw'>end</span>


	<span class='comment'># for each PoP, we build an hash containing all detailed infos
</span>	<span class='id identifier rubyid_temp_h'>temp_h</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
	<span class='id identifier rubyid_pop_detail_array'>pop_detail_array</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
	<span class='id identifier rubyid_pop_id_array'>pop_id_array</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_pop_id'>pop_id</span><span class='op'>|</span>
		<span class='kw'>begin</span>
			<span class='id identifier rubyid_pop_detail'>pop_detail</span> <span class='op'>=</span> <span class='const'>RestClient</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_base_ir_address'>base_ir_address</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/pop/</span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_pop_id'>pop_id</span><span class='comma'>,</span> <span class='symbol'>:accept</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/occi+json</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
		<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
			<span class='kw'>if</span> <span class='id identifier rubyid_debugprint'>debugprint</span> <span class='op'>==</span> <span class='kw'>true</span>
				<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>API call fail /pop/&lt;pop_id&gt;/\n</span><span class='tstring_end'>&#39;</span></span>
			<span class='kw'>end</span>
			<span class='kw'>return</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>status</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='op'>-</span><span class='int'>17</span><span class='comma'>,</span>
					<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API call fail: /pop/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_pop_id'>pop_id</span><span class='rbrace'>}</span>
			<span class='comment'>#pop_detail = dummyRest.dummy_pop_detail_query(pop_id)
</span>		<span class='kw'>end</span>
		<span class='id identifier rubyid_temp_h'>temp_h</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_pop_detail'>pop_detail</span><span class='rparen'>)</span>
		<span class='id identifier rubyid_clear_unused_keys'>clear_unused_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_temp_h'>temp_h</span><span class='rparen'>)</span>
		<span class='id identifier rubyid_pop_detail_array'>pop_detail_array</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_temp_h'>temp_h</span><span class='rparen'>)</span>
	<span class='kw'>end</span>


	<span class='comment'># Do the same with the links between PoPs
</span>	<span class='id identifier rubyid_pop_link_id_array'>pop_link_id_array</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
	<span class='kw'>begin</span>
		<span class='id identifier rubyid_pop_link_list'>pop_link_list</span> <span class='op'>=</span> <span class='const'>RestClient</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_base_ir_address'>base_ir_address</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/pop/link/</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='symbol'>:accept</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/occi+json</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
	<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
		<span class='kw'>if</span> <span class='id identifier rubyid_debugprint'>debugprint</span> <span class='op'>==</span> <span class='kw'>true</span>
			<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>API call fail /pop/link/</span><span class='tstring_end'>&#39;</span></span>
		<span class='kw'>end</span>
		<span class='kw'>return</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>status</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='op'>-</span><span class='int'>18</span><span class='comma'>,</span>
				<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API call fail: /pop/link</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
		<span class='comment'>#pop_link_list = dummyRest.dummy_pop_link_query()
</span>	<span class='kw'>end</span>
	<span class='id identifier rubyid_temp_h'>temp_h</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_pop_link_list'>pop_link_list</span><span class='rparen'>)</span>
	<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Number of PoP links = </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_temp_h'>temp_h</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
	<span class='id identifier rubyid_temp_h'>temp_h</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_pop_link'>pop_link</span><span class='op'>|</span>
		<span class='id identifier rubyid_pop_link_id_array'>pop_link_id_array</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_pop_link'>pop_link</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>identifier</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
	<span class='kw'>end</span>


	<span class='comment'># request detailed link descriptions
</span>	<span class='id identifier rubyid_temp_h'>temp_h</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
	<span class='id identifier rubyid_pop_link_detail_array'>pop_link_detail_array</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
	<span class='id identifier rubyid_pop_link_id_array'>pop_link_id_array</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_pop_link_id'>pop_link_id</span><span class='op'>|</span>
		<span class='kw'>begin</span>
			<span class='id identifier rubyid_pop_link_detail'>pop_link_detail</span> <span class='op'>=</span> <span class='const'>RestClient</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_base_ir_address'>base_ir_address</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/pop/link/</span><span class='tstring_end'>&#39;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_pop_link_id'>pop_link_id</span><span class='comma'>,</span> <span class='symbol'>:accept</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/occi+json</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
		<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
			<span class='kw'>if</span> <span class='id identifier rubyid_debugprint'>debugprint</span> <span class='op'>==</span> <span class='kw'>true</span>
				<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>API call fail /pop/link/&lt;pop_link_id&gt;/</span><span class='tstring_end'>&#39;</span></span>
			<span class='kw'>end</span>
			<span class='kw'>return</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>status</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='op'>-</span><span class='int'>19</span><span class='comma'>,</span>
					<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API call fail: /pop/link/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_pop_link_id'>pop_link_id</span><span class='rbrace'>}</span>
			<span class='comment'>#pop_link_detail = dummyRest.dummy_pop_link_detail_query(pop_link_id)
</span>		<span class='kw'>end</span>
			<span class='id identifier rubyid_temp_h'>temp_h</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_pop_link_detail'>pop_link_detail</span><span class='rparen'>)</span>
			<span class='id identifier rubyid_clear_unused_keys'>clear_unused_keys</span><span class='lparen'>(</span><span class='id identifier rubyid_temp_h'>temp_h</span><span class='rparen'>)</span>
			<span class='comment'># Convert Gbps -&gt; Mbps
</span>			<span class='id identifier rubyid_temp_h'>temp_h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attributes</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>occi.epa.pop.bw_Mbps</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_temp_h'>temp_h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attributes</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>occi.epa.pop.bw_Gps</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>*</span> <span class='int'>1024</span><span class='semicolon'>;</span>
			<span class='id identifier rubyid_temp_h'>temp_h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attributes</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>occi.epa.pop.bw_util_Mbps</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_temp_h'>temp_h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attributes</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>occi.epa.pop.bw_util_Gps</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>*</span> <span class='int'>1024</span><span class='semicolon'>;</span>
			<span class='id identifier rubyid_temp_h'>temp_h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attributes</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>occi.epa.pop.bw_Gps</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
			<span class='id identifier rubyid_temp_h'>temp_h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attributes</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>occi.epa.pop.bw_util_Gps</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
			<span class='id identifier rubyid_pop_link_detail_array'>pop_link_detail_array</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_temp_h'>temp_h</span><span class='rparen'>)</span>
	<span class='kw'>end</span>


	<span class='comment'># Now we take care of the resources of each PoP. Note that, as now, we only farm for cpu, ram and hdd.
</span>	<span class='comment'># For each Pop, now we get the list of the hypervisors
</span>	<span class='id identifier rubyid_pop_hypervisors_hash'>pop_hypervisors_hash</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
	<span class='id identifier rubyid_hypervisors_list_hash'>hypervisors_list_hash</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
	<span class='id identifier rubyid_number_of_hypervisors'>number_of_hypervisors</span> <span class='op'>=</span> <span class='int'>0</span>
	<span class='id identifier rubyid_pop_id_array'>pop_id_array</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_pop_id'>pop_id</span><span class='op'>|</span>
		<span class='kw'>begin</span>
			<span class='id identifier rubyid_pop_hypervisors_list'>pop_hypervisors_list</span> <span class='op'>=</span> <span class='const'>RestClient</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_base_ir_address'>base_ir_address</span> <span class='op'>+</span> <span class='id identifier rubyid_pop_id'>pop_id</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/hypervisor/</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='symbol'>:accept</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/occi+json</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
		<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
			<span class='kw'>if</span> <span class='id identifier rubyid_debugprint'>debugprint</span> <span class='op'>==</span> <span class='kw'>true</span>
				<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>API call fail /pop/&lt;pop-id&gt;/hypervisor/</span><span class='tstring_end'>&#39;</span></span>
			<span class='kw'>end</span>
			<span class='kw'>return</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>status</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='op'>-</span><span class='int'>20</span><span class='comma'>,</span>
					<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API call fail: /pop/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_pop_id'>pop_id</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/hypervisor</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
			<span class='comment'>#pop_hypervisors_list = dummyRest.dummy_pop_hypervisor_query( pop_id + &#39;/hypervisor/&#39; )
</span>		<span class='kw'>end</span>
		<span class='id identifier rubyid_temp_h'>temp_h</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span> <span class='id identifier rubyid_pop_hypervisors_list'>pop_hypervisors_list</span> <span class='rparen'>)</span>
		<span class='id identifier rubyid_number_of_hypervisors'>number_of_hypervisors</span> <span class='op'>+=</span> <span class='id identifier rubyid_temp_h'>temp_h</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>

		<span class='id identifier rubyid_hypervisors_per_PoP_array'>hypervisors_per_PoP_array</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
		<span class='id identifier rubyid_temp_h'>temp_h</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hypervisor_in_PoP'>hypervisor_in_PoP</span><span class='op'>|</span>
			<span class='id identifier rubyid_hypervisors_per_PoP_array'>hypervisors_per_PoP_array</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span> <span class='id identifier rubyid_hypervisor_in_PoP'>hypervisor_in_PoP</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>identifier</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='rparen'>)</span>
		<span class='kw'>end</span>
		<span class='id identifier rubyid_hypervisors_list_hash'>hypervisors_list_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_pop_id'>pop_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_hypervisors_per_PoP_array'>hypervisors_per_PoP_array</span>
	<span class='kw'>end</span>
	<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Total number of hypervisors queried = </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_number_of_hypervisors'>number_of_hypervisors</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
	<span class='comment'># example hypervisors_list_hash:
</span>	<span class='comment'>#{
</span>	<span class='comment'>#	&quot;/pop/55ef7cce-1e9b-4b8f-9839-d40ceeb670f4&quot;: [
</span>	<span class='comment'>#		&quot;/pop/55ef7cce-1e9b-4b8f-9839-d40ceeb670f4/hypervisor/hypervisor-1&quot;,
</span>	<span class='comment'>#		&quot;/pop/55ef7cce-1e9b-4b8f-9839-d40ceeb670f4/hypervisor/hypervisor-2&quot;],
</span>	<span class='comment'>#	&quot;/pop/55ef7cce-1e9b-4b8f-9839-d40ceeb670f5&quot;: [
</span>	<span class='comment'>#	    &quot;/pop/55ef7cce-1e9b-4b8f-9839-d40ceeb670f5/hypervisor/hypervisor-1&quot;,
</span>	<span class='comment'>#	    &quot;/pop/55ef7cce-1e9b-4b8f-9839-d40ceeb670f5/hypervisor/hypervisor-2&quot;,
</span>	<span class='comment'>#	    &quot;/pop/55ef7cce-1e9b-4b8f-9839-d40ceeb670f5/hypervisor/hypervisor-3&quot;]
</span>	<span class='comment'>#}
</span>
	<span class='comment'># For each hypervisors, we collect the data for calculating the free aggregated resources.
</span>	<span class='comment'># Note that we just do this for ram, cpu and hdd
</span>	<span class='comment'># --TODO-- The total free resources are currently horribly wrong since they also consider the resources
</span>	<span class='comment'>#          of the controller machines! I know that it must be filtered onto the compute nodes only!!!
</span>	<span class='id identifier rubyid_hypervisors_detail_hash'>hypervisors_detail_hash</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
	<span class='id identifier rubyid_pop_id_array'>pop_id_array</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_pop_id'>pop_id</span><span class='op'>|</span>
		<span class='id identifier rubyid_pop_aggregate_cpus'>pop_aggregate_cpus</span> <span class='op'>=</span> <span class='int'>0</span>
		<span class='id identifier rubyid_pop_aggregate_ram'>pop_aggregate_ram</span> <span class='op'>=</span> <span class='int'>0</span>
		<span class='id identifier rubyid_pop_aggregate_hdd'>pop_aggregate_hdd</span> <span class='op'>=</span> <span class='int'>0</span>
		<span class='id identifier rubyid_pop_aggregate_cpu_aesni'>pop_aggregate_cpu_aesni</span> <span class='op'>=</span> <span class='int'>0</span>
		<span class='id identifier rubyid_pop_aggregate_data'>pop_aggregate_data</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
		<span class='id identifier rubyid_hypervisors_list_hash'>hypervisors_list_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_pop_id'>pop_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_hypervisor_id'>hypervisor_id</span><span class='op'>|</span>

			<span class='kw'>begin</span>
				<span class='id identifier rubyid_hypervisor_detail'>hypervisor_detail</span> <span class='op'>=</span> <span class='const'>RestClient</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_base_ir_address'>base_ir_address</span> <span class='op'>+</span> <span class='id identifier rubyid_hypervisor_id'>hypervisor_id</span><span class='comma'>,</span> <span class='symbol'>:accept</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/occi+json</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
			<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
				<span class='kw'>if</span> <span class='id identifier rubyid_debugprint'>debugprint</span> <span class='op'>==</span> <span class='kw'>true</span>
					<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>API call fail /pop/&lt;pop-id&gt;/hypervisor/&lt;hypervisor_id&gt;</span><span class='tstring_end'>&#39;</span></span>
					<span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_pop_id'>pop_id</span> <span class='op'>+</span> <span class='id identifier rubyid_hypervisor_id'>hypervisor_id</span>
				<span class='kw'>end</span>
				<span class='kw'>return</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>status</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='op'>-</span><span class='int'>21</span><span class='comma'>,</span>
						<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API call fail: /pop/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_pop_id'>pop_id</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/hypervisor</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_hypervisor_id'>hypervisor_id</span><span class='rbrace'>}</span>
				<span class='comment'>#hypervisor_detail = dummyRest.dummy_hypervisor_detail_query( pop_id + hypervisor_id )
</span>			<span class='kw'>end</span>

			<span class='id identifier rubyid_hypervisor_detail_hash'>hypervisor_detail_hash</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span> <span class='id identifier rubyid_hypervisor_detail'>hypervisor_detail</span> <span class='rparen'>)</span>
			<span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_hypervisor_detail_hash'>hypervisor_detail_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attributes</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>occi.epa.attributes</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>String</span>
				<span class='id identifier rubyid_hypervisor_occi_epa_attributes_hash'>hypervisor_occi_epa_attributes_hash</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span> <span class='id identifier rubyid_hypervisor_detail_hash'>hypervisor_detail_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attributes</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>occi.epa.attributes</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='rparen'>)</span>
			<span class='kw'>else</span>
				<span class='id identifier rubyid_hypervisor_occi_epa_attributes_hash'>hypervisor_occi_epa_attributes_hash</span> <span class='op'>=</span> <span class='id identifier rubyid_hypervisor_detail_hash'>hypervisor_detail_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>attributes</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>occi.epa.attributes</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
			<span class='kw'>end</span>

			<span class='id identifier rubyid_cpus'>cpus</span>       <span class='op'>=</span> <span class='id identifier rubyid_hypervisor_occi_epa_attributes_hash'>hypervisor_occi_epa_attributes_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>vcpus</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
			<span class='id identifier rubyid_vcpus_used'>vcpus_used</span> <span class='op'>=</span> <span class='id identifier rubyid_hypervisor_occi_epa_attributes_hash'>hypervisor_occi_epa_attributes_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>vcpus_used</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
			<span class='id identifier rubyid_ram'>ram</span>        <span class='op'>=</span> <span class='id identifier rubyid_hypervisor_occi_epa_attributes_hash'>hypervisor_occi_epa_attributes_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>memory_mb</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
			<span class='id identifier rubyid_ram_used'>ram_used</span>   <span class='op'>=</span> <span class='id identifier rubyid_hypervisor_occi_epa_attributes_hash'>hypervisor_occi_epa_attributes_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>memory_mb_used</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
			<span class='id identifier rubyid_hdd'>hdd</span>        <span class='op'>=</span> <span class='id identifier rubyid_hypervisor_occi_epa_attributes_hash'>hypervisor_occi_epa_attributes_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>local_gb</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
			<span class='id identifier rubyid_hdd_used'>hdd_used</span>   <span class='op'>=</span> <span class='id identifier rubyid_hypervisor_occi_epa_attributes_hash'>hypervisor_occi_epa_attributes_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>local_gb_used</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>

			<span class='comment'># Actual limits found on the OpenStack docs: 16 vcpus for each physical core and 1.5MB virtual ram
</span>			<span class='comment'># for each MB or ram. Disregard them and return only the difference between physical cores and vcpu used
</span>			<span class='comment'># (as suggested by Intel).
</span>			<span class='comment'># 14/Mar/16: enabling optional overcommitting
</span>			<span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_overcommiting'>overcommiting</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>true</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
				<span class='id identifier rubyid_pop_aggregate_cpus'>pop_aggregate_cpus</span> <span class='op'>+=</span> <span class='id identifier rubyid_cpus'>cpus</span> <span class='op'>*</span> <span class='int'>16</span> <span class='op'>-</span> <span class='id identifier rubyid_vcpus_used'>vcpus_used</span>
				<span class='id identifier rubyid_pop_aggregate_ram'>pop_aggregate_ram</span>  <span class='op'>+=</span> <span class='id identifier rubyid_ram'>ram</span> <span class='op'>*</span> <span class='float'>1.5</span> <span class='op'>-</span> <span class='id identifier rubyid_ram_used'>ram_used</span>
			<span class='kw'>else</span>
				<span class='id identifier rubyid_pop_aggregate_cpus'>pop_aggregate_cpus</span> <span class='op'>+=</span> <span class='id identifier rubyid_cpus'>cpus</span> <span class='op'>-</span> <span class='id identifier rubyid_vcpus_used'>vcpus_used</span>
				<span class='id identifier rubyid_pop_aggregate_ram'>pop_aggregate_ram</span>  <span class='op'>+=</span> <span class='id identifier rubyid_ram'>ram</span> <span class='op'>-</span> <span class='id identifier rubyid_ram_used'>ram_used</span>
			<span class='kw'>end</span>
			<span class='id identifier rubyid_pop_aggregate_hdd'>pop_aggregate_hdd</span>  <span class='op'>+=</span> <span class='id identifier rubyid_hdd'>hdd</span> <span class='op'>-</span> <span class='id identifier rubyid_hdd_used'>hdd_used</span>

			<span class='kw'>if</span> <span class='id identifier rubyid_hypervisor_occi_epa_attributes_hash'>hypervisor_occi_epa_attributes_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cpu_info</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>features</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aes</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
				<span class='id identifier rubyid_pop_aggregate_cpu_aesni'>pop_aggregate_cpu_aesni</span> <span class='op'>+=</span> <span class='int'>1</span>
			<span class='kw'>end</span>

		<span class='kw'>end</span>
		<span class='id identifier rubyid_pop_aggregate_data'>pop_aggregate_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aggregate_cpus</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_pop_aggregate_cpus'>pop_aggregate_cpus</span>
		<span class='id identifier rubyid_pop_aggregate_data'>pop_aggregate_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aggregate_ram</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>  <span class='op'>=</span> <span class='id identifier rubyid_pop_aggregate_ram'>pop_aggregate_ram</span>
		<span class='id identifier rubyid_pop_aggregate_data'>pop_aggregate_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aggregate_hdd</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>  <span class='op'>=</span> <span class='id identifier rubyid_pop_aggregate_hdd'>pop_aggregate_hdd</span>
		<span class='id identifier rubyid_pop_aggregate_data'>pop_aggregate_data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>aggregate_cpu_accel_aes-ni</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>  <span class='op'>=</span> <span class='id identifier rubyid_pop_aggregate_cpu_aesni'>pop_aggregate_cpu_aesni</span>
		<span class='id identifier rubyid_hypervisors_detail_hash'>hypervisors_detail_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_pop_id'>pop_id</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_pop_aggregate_data'>pop_aggregate_data</span>
	<span class='kw'>end</span>

	<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Done querying hypervisors</span><span class='tstring_end'>&quot;</span></span>

	<span class='comment'># Take care of the EPA features: collect the number of DPDK-enabled NICs and the number of GPUs in each PoP
</span>	<span class='comment'># and store in the PoP_aggregate_resources hash
</span>	<span class='id identifier rubyid_pop_id_array'>pop_id_array</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_pop_id'>pop_id</span><span class='op'>|</span>
		<span class='kw'>begin</span>
			<span class='id identifier rubyid_dpdk_pcidev_list'>dpdk_pcidev_list</span> <span class='op'>=</span> <span class='const'>RestClient</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_base_ir_address'>base_ir_address</span> <span class='op'>+</span> <span class='id identifier rubyid_pop_id'>pop_id</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/pcidev/?dpdk=true</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='symbol'>:accept</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/occi+json</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
		<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
			<span class='kw'>if</span> <span class='id identifier rubyid_debugprint'>debugprint</span> <span class='op'>==</span> <span class='kw'>true</span>
				<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>API call fail /pop/&lt;pop_id&gt;/pcidev/?dpdk=true</span><span class='tstring_end'>&#39;</span></span>
			<span class='kw'>end</span>
			<span class='kw'>return</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>status</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='op'>-</span><span class='int'>22</span><span class='comma'>,</span>
					<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API call fail: /pop/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_pop_id'>pop_id</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/pcidev/?dpdk=true</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
			<span class='comment'>#dpdk_pcidev_list = dummyRest.dummy_dpdk_pcidev_query(pop_id)
</span>		<span class='kw'>end</span>
		<span class='id identifier rubyid_dpdk_pcidev'>dpdk_pcidev</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_dpdk_pcidev_list'>dpdk_pcidev_list</span><span class='rparen'>)</span>
		<span class='id identifier rubyid_hypervisors_detail_hash'>hypervisors_detail_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_pop_id'>pop_id</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>dpdk_nic_count</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_dpdk_pcidev'>dpdk_pcidev</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>

		<span class='kw'>begin</span>
			<span class='id identifier rubyid_gpu_osdev_list'>gpu_osdev_list</span> <span class='op'>=</span> <span class='const'>RestClient</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='id identifier rubyid_base_ir_address'>base_ir_address</span> <span class='op'>+</span> <span class='id identifier rubyid_pop_id'>pop_id</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/osdev/?category=compute</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='symbol'>:accept</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/occi+json</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
		<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
			<span class='kw'>if</span> <span class='id identifier rubyid_debugprint'>debugprint</span> <span class='op'>==</span> <span class='kw'>true</span>
				<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>API call fail /pop/&lt;pop_id&gt;/osdev/?category=compute</span><span class='tstring_end'>&#39;</span></span>
			<span class='kw'>end</span>
			<span class='kw'>return</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>status</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='op'>-</span><span class='int'>23</span><span class='comma'>,</span>
					<span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>API call fail: /pop/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_pop_id'>pop_id</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/osdev/?category=compute</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
			<span class='comment'>#gpu_osdev_list = dummyRest.dummy_gpu_osdev_query(pop_id)
</span>		<span class='kw'>end</span>
		<span class='id identifier rubyid_gpu_osdev'>gpu_osdev</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span><span class='id identifier rubyid_gpu_osdev_list'>gpu_osdev_list</span><span class='rparen'>)</span>
		<span class='id identifier rubyid_hypervisors_detail_hash'>hypervisors_detail_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_pop_id'>pop_id</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>gpu_count</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_gpu_osdev'>gpu_osdev</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>

		<span class='comment'>## Sometimes, GPU are not recognized by the OS, expecially when PCI-passthrough is enabled and
</span>		<span class='comment'>## no drivers have been installed on the host OS.
</span>		<span class='comment'>## Try the naive approach (get all the pcidev of each PoP, duh!)
</span>		<span class='comment'>## Experimental - disabled for now
</span>		<span class='comment'>#begin
</span>		<span class='comment'>#	pcidev_list = RestClient.get(base_ir_address + pop_id + &#39;/pcidev/&#39;, :accept =&gt; &#39;application/occi+json&#39;)
</span>		<span class='comment'>#rescue =&gt; e
</span>		<span class='comment'>#	if debugprint == true
</span>		<span class='comment'>#		puts &#39;API call fail /pop/&lt;pop_id&gt;/pcidev/&#39;
</span>		<span class='comment'>#	end
</span>		<span class='comment'>#	return {&#39;status&#39; =&gt; -22,
</span>		<span class='comment'>#			&#39;error&#39; =&gt; &quot;API call fail: /pop/&quot; + pop_id + &quot;/pcidev/&quot;}
</span>		<span class='comment'>#end
</span>		<span class='comment'>#pcidev_hash = JSON.parse(pcidev_list)
</span>		<span class='comment'>#gpu_counter = 0
</span>		<span class='comment'>#pcidev_hash.each do |pcidev|
</span>		<span class='comment'>#	begin
</span>		<span class='comment'>#		pcidev_detail = RestClient.get(base_ir_address + pcidev[&quot;identifier&quot;], :accept =&gt; &#39;application/occi+json&#39;)
</span>		<span class='comment'>#	rescue =&gt; e
</span>		<span class='comment'>#		if debugprint == true
</span>		<span class='comment'>#			puts &#39;API call fail /pop/&lt;pop_id&gt;/pcidev/&lt;pci_id&gt;&#39;
</span>		<span class='comment'>#		end
</span>		<span class='comment'>#		return {&#39;status&#39; =&gt; -22,
</span>		<span class='comment'>#				&#39;error&#39; =&gt; &quot;API call fail: /pop/&quot; + pop_id + &quot;/pcidev/&lt;pci_id&gt;&quot;}
</span>		<span class='comment'>#	end
</span>		<span class='comment'>#	pcidev_detail_hash = JSON.parse(pcidev_detail)
</span>		<span class='comment'>#	if pcidev_detail_hash[&quot;attributes&quot;][&quot;occi.epa.attributes&quot;].include? &quot;NVIDIA&quot;
</span>		<span class='comment'>#		gpu_counter = gpu_counter + 1
</span>		<span class='comment'>#		puts &quot;gpu found at &quot; + pcidev_detail_hash[&quot;attributes&quot;][&quot;occi.epa.hostname&quot;]
</span>		<span class='comment'>#	end
</span>		<span class='comment'>#end
</span>		<span class='comment'>#hypervisors_detail_hash[pop_id][&quot;gpu_count&quot;] = gpu_counter
</span>	<span class='kw'>end</span>


	<span class='comment'># build the final hash...
</span>	<span class='id identifier rubyid_outputHash'>outputHash</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
	<span class='id identifier rubyid_outputHash'>outputHash</span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span><span class='lparen'>(</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>PoP_id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_pop_id_array'>pop_id_array</span> <span class='rparen'>)</span>
	<span class='id identifier rubyid_outputHash'>outputHash</span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span><span class='lparen'>(</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>PoP_detail</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_pop_detail_array'>pop_detail_array</span> <span class='rparen'>)</span>
	<span class='id identifier rubyid_outputHash'>outputHash</span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span><span class='lparen'>(</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>PoP_link_id</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_pop_link_id_array'>pop_link_id_array</span> <span class='rparen'>)</span>
	<span class='id identifier rubyid_outputHash'>outputHash</span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span><span class='lparen'>(</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>PoP_link_detail</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_pop_link_detail_array'>pop_link_detail_array</span> <span class='rparen'>)</span>
	<span class='comment'># useless
</span>	<span class='comment'>#outputHash.store( &quot;Hypervisors_list&quot;, hypervisors_list_hash )
</span>	<span class='id identifier rubyid_outputHash'>outputHash</span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span><span class='lparen'>(</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>PoP_aggregate_resources</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_hypervisors_detail_hash'>hypervisors_detail_hash</span> <span class='rparen'>)</span>

	<span class='comment'># ...and save it to disk
</span>	<span class='id identifier rubyid_niFile'>niFile</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>bin/workspace/NI.json</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>w</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_f'>f</span><span class='op'>|</span>
		<span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_pretty_generate'>pretty_generate</span><span class='lparen'>(</span> <span class='id identifier rubyid_outputHash'>outputHash</span> <span class='rparen'>)</span>
	<span class='kw'>end</span>

	<span class='kw'>return</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>status</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='int'>0</span><span class='comma'>,</span>
                       <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>error</span><span class='tstring_end'>&#39;</span></span><span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Ok</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>


<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Mon Oct 10 15:35:23 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.5 (ruby-2.3.0).
</div>

    </div>
  </body>
</html>